<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Atlas Frontend</title>

  <script src="https://unpkg.com/vue"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
          crossorigin="anonymous"></script>
  <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      media="all" rel="stylesheet"/>
  <link href="src/css/env-dropdown.css" media="all" rel="stylesheet"/>

</head>
<body>
<div id="atlas-navbar">
  <atlas-navbar
      :routes="routes"
      :environments="environments">
  </atlas-navbar>
</div>
<div class="page container">
  <message-area id="alert" :messages="messages" v-if="messages.length > 0"></message-area>
<div id="site-listing" class="row">
  <form id="search" class="row">
    <div class="form-group">
      <label for="query">Search</label>
      <input id="query" class="form-control" name="query"
             v-model="searchQuery">
    </div>
    <div class="form-group">
      <button class="btn btn-primary" @click.prevent="search(searchQuery)">Search</button>
      <button class="btn btn-default" v-if="reset" @click.prevent="resetSearch()">Reset</button>
    </div>
  </form>
  <div class="row">
    <listing
        :data="gridData"
        :columns="gridColumns"
        :filter-key="searchQuery"
        :edit-keys="editKeys"
        :select-keys="selectKeys"
        :callback="callback">
    </listing>
  </div>
</div>
<div id="create-site" class="row">
  <confirm-button
      :label="label"
      :callback="callback">
  </confirm-button>
</div>
</div>
<!-- Static navbar -->
<script type="text/x-template" id="a-navbar">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed"
                data-toggle="collapse" data-target="#navbar"
                aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand">Atlas Front-end</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li v-for="route in routes"><a :href="route.path">{{route.name}}</a></li>
        </ul>
        <div class="nav navbar-nav navbar-right">
          <div class="styled-select slate">
            <select name="selectEnv" id="selectEnv" @change="changeEnv($event)">
              <option v-for="(env, index) in environments" :value="index" :selected="selectedEnv == env ? true : null">
                {{index}}
              </option>
            </select>
          </div>
        </div>
      </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
  </nav>
</script>
<!-- component template -->
<script type="text/x-template" id="listing">
  <div class="lisitng-wrapper">
    <div class="result-count">Result Count: {{resultCount}}</div>
    <table class="table">
      <thead>
      <tr>
        <th v-for="key in columns"
            @click="sortBy(key)"
            :class="{ active: sortKey == key }">
          {{ key | capitalize }}
          <span class="arrow" :class="sortOrders[key] > 0 ? 'asc' : 'dsc'">
          </span>
        </th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr v-for="(entry, index) in filteredData" scope="row">
        <!-- Row with data and edit/inputs -->
        <td v-for="key in columns">
          <div v-if="showDefault(entry, key)" v-html="link(entry[key],key)"></div>
          <div v-if="selectType(key)">
            <select v-if="showEdit(entry, key)" :name="key" :data-id="entry.id">
              <option v-for="anOption in selectOptions[key]" :value="anOption" :selected=" entry[key] == anOption ? true : null">{{anOption}}</option>
            </select>
          </div>
          <div v-else>
            <input v-if="showEdit(entry, key)" type="text" :name="key" :data-id="entry.id" :value="entry[key]">
          </div>
        </td>
        <!-- @todo Only add Edit option if there are editKeys -->
        <td>
          <button v-if="showDefault(entry)" class="btn btn-default" v-on:click="makeEdit(entry)" :data-id="entry.id">Edit</button>
          <button v-if="showEdit(entry)" class="btn btn-default" v-on:click="callMeMaybe(callback, entry)" :data-id="entry.id">Send</button>
          <button v-if="showEdit(entry)" class="btn btn-default" v-on:click="cancelEdit()" :data-id="entry.id">Cancel</button>
          <confirm-button v-if="showEdit(entry)" label="Delete"
                          callback="deleteRecord"
                          :params="entry">
          </confirm-button>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</script>
<!-- component template -->
<script type="text/x-template" id="confirm-button">
  <div class="button-wrapper">
    <button class="btn btn-primary" v-if="!confirmed" @click="confirm()">{{label}}</button>
    <button class="btn btn-warning" v-if="confirmed && !finaled" @click="final()">Set?</button>
    <button class="btn btn-danger" v-if="finaled" @click="callMeMaybe(callback, params)">Fire!</button>
    <button class="btn btn-default" v-if="finaled || confirmed" @click="cancel()">Cancel</button>
  </div>
</script>

<script src="src/config/config.js"></script>
<script src="src/config/routes.js"></script>
<script src="src/js/utilities.js"></script>
<script src="src/js/navbar.js"></script>
<script src="src/js/site-listing.js"></script>
<script type="text/javascript">
  /**
   * Creates the list of site records based on the environment. Every time the environment
   * changes via the environment selector, the search will update.
   */
  $(document).ready(function () {
    let cachedRecords = {};
    getSiteRecords(siteConfig['atlasEnvironments'][localStorage.getItem('env')])
      .then(function (data) {
        siteListing.gridData = data;
        // Cache the result until the next request.
        siteListing.cachedRecords = data;
      });
  });
</script>
</body>
</html>
